<head>
    <title>TO DO APP</title>
    <!-- to do: the proper of static
        https://docs.djangoproject.com/en/3.2/howto/static-files/ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        ul {
            list-style-type: none;
        }
    </style>
</head>
<body>
    <!-- <h1>TO DO APP</h1> -->
    <!-- <center><h2><p>To do app : {{ name }}<p></h2></center>
    <br>
    <center><a href="{% url 'hello-add' %}">Add Action </a></center>
    <br>
    <div class="d-flex justify-content-center">
        <table class='text-center'>
            <thead>
                <tr>
                 <th> <h2> Activities </h2> </th>
                 <th><h2> Actions </h2></th>
                <tr>
            </thead>

            {% for t in to_do %}
            <tr>
                <td><h3>{{ t.text }}</h3></td>
                <td>
                    <a href="{% url 'hello-view' t.pk %}"> View</a>
                    <a href="{% url 'hello-update' t.pk %}"> Update</a>
                    <a href="{% url 'hello-delete' t.pk %}">Delete</a>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div> -->

    <center><h2><p id='namePlease'>To do app : None <p></h2></center>
    <center><button class="add" name="Add" onclick='addAction(this)'>Add Action</button></center>
    <br>
    <br>
    <div class="d-flex justify-content-center">
        <table class='text-center'>
            <thead>
                <tr>
                 <th> <h2> Activities </h2> </th>
                 <th><h2> Actions </h2></th>
                <tr>
            </thead>

            <tbody id='bodyAction'></tbody>
        </table>
    </div>
    <br>
    <br>
    <center>Add or Update Form</center>
    <center>Push add button if you want to add, else update if you want to update</center>
    <div class="d-flex justify-content-center">

        <form id='actionForm'>
            {{ create_or_update.as_ul }}
        </form>
    </div>

    {% csrf_token %}
    <script>
        // list
        $.ajax({
            type: 'GET',
            url: '/api/list/',
            success: function(resp){
                var data = resp;
                console.log(data);
                $('#namePlease').text("To do app" + ' : ' +  data.name);

                for(let i=0; i < data.to_do.length; i++){
                    var item = data.to_do[i];

                    $('#bodyAction').append(
                    `<tr id=${i}>
                        <td id="actionText">
                            <h3 id="actionTextHeader"> ${ item.text } </h3>
                        </td>
                        <td id="actionButton">
                            <button class="view" name="view" value=${item.id} onclick="viewAction(this)">View</button>
                            <button class="update" name="view" value=${item.id} onclick="updateAction(this,  ${i})">Update</button>
                            <button class="delete" name="delete" value=${item.id} onclick="deleteAction(this, ${i})">Delete</button>
                        </td>
                    </tr>
                    `
                    )
                }
            },
            error: function(resp){
                console.log(resp);
            }
        })

        // get
        function viewAction(obj){
            console.log(obj.value);
            $.ajax({
                type: 'GET',
                url: `/api/view/${obj.value}/`,
                success: function(resp){
                    var data = resp.data;
                    alert(`id: ${data.id} - text: ${data.text} - description: ${data.description}`)
                },
                error: function(resp){
                    console.log(resp);
                }
            })
        }

        // https://docs.djangoproject.com/en/3.2/ref/csrf/
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        console.log(csrftoken);

        // delete
        function deleteAction(obj, index){
            console.log(index);
            if(confirm('Are you sure you want to delete it?')){
                console.log(this);
                $.ajax({
                    url: `/api/delete/${obj.value}/`,
                    type: 'DELETE',
                    headers: {'X-CSRFToken': csrftoken},
                    data: {},
                    success: function(resp){
                        $('#bodyAction').find('tr')[index].remove();
                    },
                    error: function(resp){
                        console.log(resp);
                    }
                })
            }

        }

        // add
        function addAction(obj){
            console.log(obj);
            // targeted fields
            var text = $('#id_text').val();
            var description = $('#id_description').val();
            console.log(text + ' ' + description);

            $.ajax({
                url: `/api/add/`,
                type: 'POST',
                headers: {'X-CSRFToken': csrftoken},
                data: {
                    'text': text,
                    'description': description
                },
                success: function(resp){
                    var data = resp
                    var rowCount = $('#bodyAction tr').length;
                    $('#bodyAction').append(
                        `<tr id=${rowCount}>
                        <td id="actionText">
                            <h3> ${data.text} </h3>
                        </td id="actionButton">
                        <td>
                            <button class="view" name="view" value=${data.id} onclick="viewAction(this)">View</button>
                            <button class="update" name="view" value=${data.id} onclick="updateAction(this, ${rowCount})">Update</button>
                            <button class="delete" name="delete" value=${data.id} onclick="deleteAction(this, ${rowCount})">Delete</button>
                        </td>
                    </tr>
                    `
                    )
                },
                error: function(resp){
                    alert(resp.responseText);
                }
            })
        }

        // update
        function updateAction(obj, index){
            var text = $('#id_text').val();
            var description = $('#id_description').val();

            $.ajax({
                url: `/api/update/${obj.value}/`,
                type: 'PUT',
                headers: {'X-CSRFToken': csrftoken},
                data: {
                    'id': obj.value,
                    'text': text,
                    'description': description
                },
                success: function(resp){
                    console.log($(`#${index} td h3`).html(resp.text));
                    $('#actionTextHeader').val(resp.text);
                },
                error: function(resp){
                    alert(resp.responseText);
                }
            })
        }

    </script>

</body>